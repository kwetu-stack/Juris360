{% extends "base.html" %}
{% block content %}
<div class="card">
  <div class="section-head">
    <h1>Invoices</h1>
    <form method="post" action="{{ url_for('invoices_create') }}" class="inline">
      <label>No.<br><input class="input" name="number" required></label>
      <label>Client<br>
        <select name="client_id" class="select" required>
          {% for c in clients %}<option value="{{ c.id }}">{{ c.name }}</option>{% endfor %}
        </select>
      </label>
      <label>Case<br>
        <select name="case_id" class="select" required>
          {% for c in cases %}<option value="{{ c.id }}">{{ c.ref }} — {{ c.title }}</option>{% endfor %}
        </select>
      </label>
      <label>Status<br>
        <select name="status_id" class="select" required>
          {% for s in status %}<option value="{{ s.id }}">{{ s.name }}</option>{% endfor %}
        </select>
      </label>
      <label>Amount<br><input class="input" type="number" step="0.01" name="amount" required></label>
      <label>Due Date<br><input class="input" type="date" name="due_date"></label>
      <button class="btn primary">Add</button>
    </form>
  </div>
  <table>
    <thead><tr><th>No.</th><th>Client</th><th>Case</th><th>Status</th><th>Amount</th><th>Due</th><th>Actions</th></tr></thead>
    <tbody>
      {% for r in rows %}
      <tr>
        <td>{{ r.number }}</td>
        <td>{{ r.client.name }}</td>
        <td>{{ r.case.ref }} — {{ r.case.title }}</td>
        <td><span class="badge {{ r.status.name|lower }}">{{ r.status.name }}</span></td>
        <td>{{ '%.2f'|format(r.amount or 0) }}</td>
        <td>{{ r.due_date.strftime('%Y-%m-%d') if r.due_date else '' }}</td>
        <td class="actions" style="display:flex;gap:.5rem;flex-wrap:wrap;align-items:center">
          <a class="btn ghost" target="_blank" href="{{ url_for('invoice_view', id=r.id) }}">Print</a>
          <a class="btn ghost" href="{{ url_for('invoice_pdf', id=r.id) }}">PDF</a>
          <a class="btn ghost" href="{{ url_for('invoices_edit', id=r.id) }}">Edit</a>
          <form method="post" action="{{ url_for('invoices_delete', id=r.id) }}" onsubmit="return confirm('Delete invoice?')">
            <button class="btn danger">Delete</button>
          </form>
        </td>
      </tr>
      {% endfor %}
      {% if not rows %}<tr><td colspan="7" class="small">No invoices yet.</td></tr>{% endif %}
    </tbody>
  </table>
</div>

{% if edit %}
<div class="card">
  <h2>Edit Invoice</h2>

  <div style="display:flex;gap:.5rem;margin-bottom:10px;flex-wrap:wrap">
    <a class="btn ghost" target="_blank" href="{{ url_for('invoice_view', id=edit.id) }}">Print</a>
    <a class="btn ghost" href="{{ url_for('invoice_pdf', id=edit.id) }}">PDF</a>
  </div>

  <form method="post" action="{{ url_for('invoices_update', id=edit.id) }}" class="grid cols-3">
    <label>No.<input class="input" name="number" value="{{ edit.number }}" required></label>
    <label>Client<select name="client_id" class="select" required>
      {% for c in clients %}<option value="{{ c.id }}" {% if edit.client_id==c.id %}selected{% endif %}>{{ c.name }}</option>{% endfor %}
    </select></label>
    <label>Case<select name="case_id" class="select" required>
      {% for c in cases %}<option value="{{ c.id }}" {% if edit.case_id==c.id %}selected{% endif %}>{{ c.ref }} — {{ c.title }}</option>{% endfor %}
    </select></label>
    <label>Status<select name="status_id" class="select" required>
      {% for s in status %}<option value="{{ s.id }}" {% if edit.status_id==s.id %}selected{% endif %}>{{ s.name }}</option>{% endfor %}
    </select></label>
    <label>Amount<input class="input" type="number" step="0.01" name="amount" value="{{ edit.amount }}"></label>
    <label>Due Date<input class="input" type="date" name="due_date" value="{{ edit.due_date.strftime('%Y-%m-%d') if edit.due_date else '' }}"></label>
    <div><button class="btn primary">Save</button></div>
  </form>

  <hr style="margin:16px 0">

  <h3>Record Payment</h3>
  <form method="post" action="{{ url_for('invoice_payment_add', id=edit.id) }}" class="grid cols-3">
    <label>Amount<input class="input" type="number" step="0.01" min="0.01" name="amount" required></label>
    <label>Date<input class="input" type="date" name="date" value="{{ (edit.due_date or None)|default('', true) }}"></label>
    <label>Method
      <select class="select" name="method">
        <option>Cash</option><option>Bank</option><option>Card</option>
        <option>M-Pesa</option><option>Cheque</option><option>Other</option>
      </select>
    </label>
    <label class="colspan-3">Reference<input class="input" name="reference" placeholder="Txn/Chq/Ref #"></label>
    <label class="colspan-3">Note<textarea class="input" name="note" rows="3"></textarea></label>
    <div><button class="btn">Save Payment</button></div>
  </form>

  {% if payments %}
    <h3 style="margin-top:12px">Payments</h3>
    <table>
      <thead><tr><th>Date</th><th>Method</th><th>Reference</th><th style="text-align:right">Amount</th></tr></thead>
      <tbody>
        {% for p in payments %}
        <tr>
          <td>{{ p.date.strftime('%Y-%m-%d') }}</td>
          <td>{{ p.method or '' }}</td>
          <td>{{ p.reference or '' }}</td>
          <td style="text-align:right">{{ '%.2f'|format(p.amount) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <div class="small" style="margin-top:8px">
      <strong>Total:</strong> {{ '%.2f'|format(edit.amount or 0) }} ·
      <strong>Paid:</strong> {{ '%.2f'|format(paid or 0) }} ·
      <strong>Balance:</strong> {{ '%.2f'|format(balance or 0) }}
    </div>
  {% endif %}
</div>
{% endif %}
{% endblock %}
